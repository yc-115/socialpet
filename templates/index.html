<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <title>æ¯›å­©äº¤å‹å¤©åœ° - Pet Social Universeï¼šåœ°åœ–èˆ‡å®‰å…¨ç¤¾äº¤</title>
    <meta content="å¯µç‰©ç¤¾äº¤åœ°åœ–, æ¯›å­©å‹å–„åœ°é», AI å¯µç‰©é…å°, è·¨ç‰©ç¨®ç¤¾äº¤" name="keywords">
    <meta content="å°ˆç‚ºæ‰€æœ‰å¯µç‰©è¨­è¨ˆçš„ç¤¾äº¤åœ°åœ–ï¼Œè¼•é¬†æ‰¾åˆ°é™„è¿‘çš„å‹å–„åœ°é»èˆ‡ç©ä¼´ï¼ŒAI åŠ©åŠ›å®‰å…¨ç¤¾äº¤ã€‚" name="description">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins&family=Roboto:wght@700&display=swap" rel="stylesheet">     

    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* ------------------------------------------------ */
        /* ğŸ¨ åŸºç¤æ¨£å¼èˆ‡é…è‰²å„ªåŒ– (ä¸»è‰²: #FF9933 æ´»åŠ›æ©˜) */
        /* ------------------------------------------------ */
        :root {
            --primary: #FF9933; /* æ´»åŠ›æ©˜ */
            --secondary: #6c757d;
            --success: #4CAF50; /* ç¶ è‰²ï¼Œå®‰å…¨ */
            --warning: #FFC107; /* é»ƒè‰²ï¼Œæ…¢ç†Ÿ */
            --info: #2196F3; /* è—è‰²ï¼ŒAI */
            --bg-light: #fff5e0; /* æ·ºæš–è‰²èƒŒæ™¯ */
            --bg-sidebar: #ffffff;
        }

        .text-primary { color: var(--primary) !important; }
        .bg-primary { background-color: var(--primary) !important; }
        .btn-primary { 
            background-color: var(--primary); 
            border-color: var(--primary);
        }
        .btn-primary:hover {
            background-color: #ffb76e; /* æ·ºä¸€é»çš„æ©˜ */
            border-color: #ffb76e;
        }
        .border-primary { border-color: var(--primary) !important; }
        
        /* é é¢æ•´é«”ä½ˆå±€èª¿æ•´ */
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-y: scroll; 
            font-family: 'Poppins', 'Roboto', sans-serif;
            background-color: var(--bg-light);
        }
        
        /* é ‚éƒ¨å°è¦½åˆ—å„ªåŒ–ï¼šæ›´ç°¡æ½” */
        .navbar-brand h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }
        .nav-contact {
            border-radius: 50px; /* è† å›ŠæŒ‰éˆ• */
            transition: all 0.3s ease;
        }

        /* æ‡‰ç”¨ä¸»å®¹å™¨ï¼šåœ°åœ–èˆ‡å´é‚Šæ¬„ */
        #main-app-container {
            flex-grow: 1;
            display: flex;
            min-height: calc(100vh - 100px); 
            overflow: hidden;
            background-color: #e0e0e0;
        }

        /* Leaflet åœ°åœ–å®¹å™¨ */
        #map-view {
            flex: 3;
            position: relative;
            z-index: 1; 
            padding: 0;
            margin: 0; 
        }
        
        /* å´é‚Šæ¬„å€å¡Š */
        #sidebar {
            width: 420px; /* ç¨å¾®å¯¬ä¸€é» */
            background-color: var(--bg-sidebar);
            box-shadow: -6px 0 15px rgba(0, 0, 0, 0.15); /* é™°å½±æ›´æ˜é¡¯ */
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 20px 25px; /* å¢åŠ å…§é‚Šè· */
            box-sizing: border-box;
            z-index: 2; 
        }

        /* ------------------------------------------------ */
        /* ğŸ§  AI èŠå¤©å€å¡Šæ¨£å¼ (ç¾åŒ–ç‰ˆæœ¬ï¼Œç¢ºä¿è¨Šæ¯æ°£æ³¡é¡¯ç¤ºæ­£ç¢º) */
        /* ------------------------------------------------ */
        .ai-header {
            color: var(--info);
            font-weight: 700;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--info);
            margin-bottom: 15px;
        }
        .chat-container {
            border: none;
            border-radius: 12px;
            height: 180px;
            overflow-y: auto;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f0f8ff; 
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        .user-message { 
            text-align: right; 
            color: #4a4a4a; 
            font-weight: 500; 
            margin-bottom: 8px; 
            background-color: #e3f2fd;
            padding: 5px 10px;
            border-radius: 10px 10px 0 10px;
            display: inline-block;
            max-width: 80%;
            float: right;
            clear: both;
        }
        .ai-message { 
            text-align: left; 
            color: #2e7d32; 
            margin-bottom: 8px; 
            background-color: #e8f5e9;
            padding: 5px 10px;
            border-radius: 10px 10px 10px 0;
            display: inline-block;
            max-width: 80%;
            float: left;
            clear: both;
        }
        .chat-container::after {
            content: "";
            display: table;
            clear: both;
        }

        /* ------------------------------------------------ */
        /* ğŸŒ¤ï¸ å¤©æ°£æŸ¥è©¢å€å¡Šä¿®æ­£: æ‡‰ç”¨ Flex ä½ˆå±€è®“è¼¸å…¥æ¡†å’ŒæŒ‰éˆ•å°é½Š */
        /* ------------------------------------------------ */
        .weather-container {
            background: #ffffff;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #f8d0a8;
            margin-top: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .weather-container h3 {
             font-size: 1.25rem;
             font-weight: 700;
             margin-bottom: 15px;
        }
        /* æ–°å¢ Flex å®¹å™¨ä¾†åŒ…è£è¼¸å…¥æ¡†å’ŒæŒ‰éˆ• */
        .weather-input-group {
            display: flex;
            gap: 10px; /* è¼¸å…¥æ¡†å’ŒæŒ‰éˆ•ä¹‹é–“çš„é–“éš” */
            margin-bottom: 10px;
        }
        
        .weather-container input {
            /* è®“è¼¸å…¥æ¡†ä½”æ“šå‰©é¤˜çš„æ‰€æœ‰ç©ºé–“ */
            flex-grow: 1; 
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            /* ç§»é™¤åŸæœ‰çš„ width: 100% å’Œ margin-bottom: 10px */
            width: auto; 
            margin-bottom: 0;
        }

        .weather-container button {
            /* è®“æŒ‰éˆ•å¯¬åº¦ç”±å…§å®¹æ±ºå®šï¼Œä¸¦æ‡‰ç”¨ç¾åŒ–å¾Œçš„é¡è‰² */
            width: auto; 
            padding: 10px 15px;
            background: var(--info); /* æ‡‰ç”¨ info è—è‰² */
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            color: white;
        }
        /* ------------------------------------------------ */

        .weather-result {
            margin-top: 10px;
            background: #fff8e1;
            padding: 10px;
            border-radius: 8px;
            font-weight: 500;
        }

        /* ------------------------------------------------ */
        /* ğŸ¾ æ»‘å‹•å¡ç‰‡å€å¡Šæ¨£å¼ (ç¾åŒ–ç‰ˆæœ¬) */
        /* ------------------------------------------------ */
        #swipe-card-container {
            padding: 15px;
            background-color: #f9f7f5; 
            border-radius: 15px;
            min-height: 480px; 
            position: relative;
            display: flex;
            flex-direction: column;
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .swipe-card {
            background-color: white;
            border: 1px solid #ffcc80; 
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15); 
            transition: transform 0.5s cubic-bezier(0.25, 0.1, 0.25, 1), opacity 0.5s ease;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            color: #333; 
        }
        .pet-photo-placeholder {
            width: 100%;
            height: 200px; /* å¢åŠ åœ–ç‰‡é«˜åº¦ */
            background-color: #f1f1f1;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden; 
            position: relative;
        }
        .pet-photo-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: cover; 
        }
        .pet-profile-detail h4 {
            margin-bottom: 10px;
            font-size: 1.5rem;
            color: var(--primary);
        }
        .pet-profile-detail p {
            font-size: 0.95rem;
        }
        .badge {
            font-size: 0.85rem;
            font-weight: 600;
            padding: 0.5em 0.8em;
            margin-top: 5px;
        }
        .btn-outline-primary {
             border-color: var(--primary);
             color: var(--primary);
        }
        .btn-outline-primary:hover {
            background-color: var(--primary);
            color: white;
        }
        .swipe-buttons {
            display: flex;
            justify-content: space-around;
            padding: 20px 0 5px 0; 
        }
        .swipe-buttons .btn-lg {
            border-radius: 50%; 
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem; 
            padding: 0; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .swipe-buttons .btn-lg i {
            margin: 0 !important; 
        }
        /* ç¢ºä¿é¡è‰²å’Œåœ–æ¨™ä¸€è‡´æ€§ */
        .btn-danger { 
            background-color: #F44336 !important; 
            border-color: #F44336 !important;
            color: white; /* ç¢ºä¿ X æ˜¯ç™½è‰²çš„ */
        }
        .btn-success { 
            background-color: #4CAF50 !important; 
            border-color: #4CAF50 !important; 
            color: white;
        }
        
        /* åœ°åœ–ç–Šå±¤æ§åˆ¶ (å®šä½æŒ‰éˆ•) */
        #map-overlay-controls {
            position: absolute;
            top: 15px;
            right: 15px; 
            left: auto;
            z-index: 1000;
        }
        #locate-map-btn {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            padding: 0;
            font-size: 1rem;
            margin-left: 0 !important; 
        }
        
        /* éš±è—åŸæ¨¡æ¿ä¸ç›¸é—œçš„å…§å®¹ */
        .container-fluid.border-bottom { display: none !important; }
        .hero-header, .container-fluid.py-5, .container-fluid.bg-offer, .bg-testimonial {
            display: none !important;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg bg-white navbar-light shadow-sm py-3 py-lg-0 px-3 px-lg-0">
        <a href="{{ url_for('show_main_map') }}" class="navbar-brand ms-lg-5">
            <h1 class="m-0 text-uppercase text-dark"><i class="bi bi-paw-fill fs-1 text-primary me-3"></i>æ¯›å­©äº¤å‹å¤©åœ°</h1>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarCollapse">
            <div class="navbar-nav ms-auto py-0">
                <a href="{{ url_for('show_main_map') }}" class="nav-item nav-link active">åœ°åœ–èˆ‡ç¤¾äº¤</a>
                
                <a href="{{ url_for('serve_template', template_name='passport') }}" class="nav-item nav-link">æ•¸ä½è­·ç…§</a>
                <a href="{{ url_for('serve_template', template_name='vendor') }}" class="nav-item nav-link">å‹å–„å•†å®¶</a>
                
                <div class="nav-item dropdown">
                    <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">æ›´å¤š</a>
                    <div class="dropdown-menu m-0">
                        <a href="{{ url_for('serve_template', template_name='safety') }}" class="dropdown-item">å®‰å…¨æŒ‡å¼•</a>
                        <a href="{{ url_for('serve_template', template_name='messageboard') }}" class="dropdown-item">èµ°å¤±ç•™è¨€æ¿</a>
                        <a href="{{ url_for('serve_template', template_name='knowledge') }}" class="dropdown-item">å¯µç‰©çŸ¥è­˜</a>
                    </div>
                </div>
                <a href="{{ url_for('show_upload_form') }}" class="nav-item nav-link nav-contact bg-primary text-white px-5 ms-lg-5">
                    <i class="bi bi-cloud-arrow-up-fill me-1"></i> ä¸Šå‚³æ¯›å­©
                </a>
            </div>
        </div>
    </nav>
    
    <div id="main-app-container">
        <div id="map-view">
            <div id="map-overlay-controls">
                <button id="locate-map-btn" class="btn btn-primary"><i class="bi bi-geo-alt"></i></button>
            </div>
        </div>

        <div id="sidebar">
            
            <h5 class="ai-header"><i class="bi bi-robot me-2"></i>AI æ™ºæ…§åŠ©æ‰‹</h5>
            
            <div class="chat-container" id="ai-chat-history">
                <div class="chat-message ai-message"><strong>ğŸ¤– AI:</strong> æ­¡è¿ï¼å•æˆ‘é™„è¿‘çš„æ¯›å­©åœ°é»æˆ–ç¤¾äº¤å•é¡Œå§ï¼</div>
            </div>
            <div class="input-group mb-4">
                <input type="text" class="form-control" id="gemini-input" placeholder="å•ï¼šé™„è¿‘å“ªéš»ç‹—ç‹—æœ€è¦ªäººï¼Ÿ">
                <button class="btn btn-primary" type="button" onclick="sendAIQuery()">ç™¼é€</button>
            </div>
            
            <div class="weather-container">
                <h3 class="fs-5 text-dark"><i class="bi bi-cloud-sun me-2 text-info"></i>å³æ™‚å¤©æ°£æŸ¥è©¢</h3>
                <div class="weather-input-group">
                    <input type="text" id="cityInput" placeholder="è¼¸å…¥åŸå¸‚åç¨±ï¼Œä¾‹å¦‚ï¼šTaipei">
                    <button onclick="getWeather()">æŸ¥è©¢å¤©æ°£</button>
                </div>
                <div id="weatherResult" class="weather-result"></div>
            </div>

            <h5 class="text-uppercase text-primary my-4 pt-3 border-top border-light"><i class="bi bi-rewind me-2"></i>æ¯›å­©ç¤¾äº¤å¡ç‰‡</h5>

            <div id="swipe-card-container">
            </div>

            <div class="swipe-buttons">
                <button class="btn btn-danger btn-lg" onclick="swipeAction('skip')" title="è·³é">
                    <i class="bi bi-trash-fill"></i>
                </button>
                <button class="btn btn-success btn-lg" onclick="swipeAction('like')" title="å–œæ­¡">
                    <i class="bi bi-heart-fill"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div class="container-fluid bg-light mt-5 py-5" style="margin-top: 0 !important;">
        <div class="container pt-5">
            <div class="row g-5">
                <div class="col-lg-3 col-md-6">
                    <h5 class="text-uppercase border-start border-5 border-primary ps-3 mb-4">è¯ç¹«æˆ‘å€‘</h5>
                    <p class="mb-4">è®“æˆ‘å€‘ä¸€èµ·ç‚ºæ¯›å­©æ‰“é€ æ›´ç¾å¥½çš„ç¤¾äº¤ç’°å¢ƒã€‚</p>
                    <p class="mb-2"><i class="bi bi-geo-alt text-primary me-2"></i>123 Street, New York, USA</p>
                    <p class="mb-2"><i class="bi bi-envelope-open text-primary me-2"></i>info@example.com</p>
                    <p class="mb-0"><i class="bi bi-telephone text-primary me-2"></i>+012 345 67890</p>
                </div>
                <div class="col-lg-3 col-md-6">
                    <h5 class="text-uppercase border-start border-5 border-primary ps-3 mb-4">å¿«é€Ÿé€£çµ</h5>
                    <div class="d-flex flex-column justify-content-start">
                        <a class="text-body mb-2" href="{{ url_for('show_main_map') }}"><i class="bi bi-arrow-right text-primary me-2"></i>åœ°åœ–èˆ‡ç¤¾äº¤</a>
                        <a class="text-body mb-2" href="{{ url_for('serve_template', template_name='passport') }}"><i class="bi bi-arrow-right text-primary me-2"></i>æ•¸ä½è­·ç…§</a>
                        <a class="text-body mb-2" href="{{ url_for('serve_template', template_name='vendor') }}"><i class="bi bi-arrow-right text-primary me-2"></i>å‹å–„å•†å®¶</a>
                        <a class="text-body mb-2" href="{{ url_for('serve_template', template_name='safety') }}"><i class="bi bi-arrow-right text-primary me-2"></i>å®‰å…¨æŒ‡å¼•</a>
                        <a class="text-body mb-2" href="{{ url_for('serve_template', template_name='messageboard') }}"><i class="bi bi-arrow-right text-primary me-2"></i>èµ°å¤±ç•™è¨€æ¿</a>
                        <a class="text-body" href="{{ url_for('show_upload_form') }}"><i class="bi bi-arrow-right text-primary me-2"></i>ä¸Šå‚³æ¯›å­©</a>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <h5 class="text-uppercase border-start border-5 border-primary ps-3 mb-4">è¿½è¹¤æˆ‘å€‘</h5>
                    <p class="mb-0">é—œæ³¨ç¤¾ç¾¤åª’é«”ï¼Œç²å–æœ€æ–°çš„æ¯›å­©ç¤¾äº¤æ•…äº‹èˆ‡å„ªæƒ è³‡è¨Šã€‚</p>
                    <h6 class="text-uppercase mt-4 mb-3"></h6>
                    <div class="d-flex">
                        <a class="btn btn-outline-primary btn-square me-2" href="#"><i class="bi bi-twitter"></i></a>
                        <a class="btn btn-outline-primary btn-square me-2" href="#"><i class="bi bi-facebook"></i></a>
                        <a class="btn btn-outline-primary btn-square me-2" href="#"><i class="bi bi-linkedin"></i></a>
                        <a class="btn btn-outline-primary btn-square" href="#"><i class="bi bi-instagram"></i></a>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <h5 class="text-uppercase border-start border-5 border-primary ps-3 mb-4">è¨‚é–±é›»å­å ±</h5>
                    <form action="">
                        <div class="input-group">
                            <input type="text" class="form-control p-3" placeholder="æ‚¨çš„ Email">
                            <button class="btn btn-primary">è¨‚é–±</button>
                        </div>
                    </form>
                    <p class="mt-3">ç²å– AI ç¤¾äº¤é…å°æˆåŠŸæ¡ˆä¾‹èˆ‡å¯µç‰©å¥åº·çŸ¥è­˜ã€‚</p>
                </div>
                <div class="col-12 text-center text-body">
                    <a class="text-body" href="#">æœå‹™æ¢æ¬¾</a>
                    <span class="mx-1">|</span>
                    <a class="text-body" href="#">éš±ç§æ”¿ç­–</a>
                    <span class="mx-1">|</span>
                    <a class="text-body" href="#">å®¢æˆ¶æ”¯æ´</a>
                    <span class="mx-1">|</span>
                    <a class="text-body" href="#">å¸¸è¦‹å•é¡Œ</a>
                </div>
            </div>
        </div>
    </div>
    <div class="container-fluid bg-dark text-white-50 py-4">
        <div class="container">
            <div class="row g-5">
                <div class="col-md-6 text-center text-md-start">
                    <p class="mb-md-0">&copy; <a class="text-white" href="#">æ¯›å­©äº¤å‹å¤©åœ°</a>. All Rights Reserved.</p>
                </div>
                <div class="col-md-6 text-center text-md-end">
                    <p class="mb-0">Designed based on <a class="text-white" href="https://htmlcodex.com">HTML Codex</a> Template</p>
                </div>
            </div>
        </div>
    </div>
    <a href="#" class="btn btn-primary py-3 fs-4 back-to-top"><i class="bi bi-arrow-up"></i></a>


    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        
        // ----------------------------------------------------
        // â­ JSON è§£æå’Œç´¢å¼•è¿½è¹¤ 
        // ----------------------------------------------------
        const petDataJsonString = '{{ pets | tojson | safe }}'; 
        
        let realPetsData = [];
        try {
            realPetsData = JSON.parse(petDataJsonString);
        } catch (e) {
            console.error("ç„¡æ³•è§£æå¯µç‰©è³‡æ–™:", e);
        }
        
        // æ¢å¾©åŸå§‹çš„ Jinja æ¨¡æ¿è·¯å¾‘
        let availablePets = realPetsData.length > 0 ? realPetsData.slice() : [ 
            { id: 999, name: "æ¸¬è©¦ç‹—", species: "ç±³å…‹æ–¯", image_url: "{{ url_for('static', filename='mock_dog.png', _external=True) }}", tags: ["æ„›è·‘è·³", "å°ç‹—å‹å–„"], location: "æ¨¡æ“¬å…¬åœ’", interactionNote: "å–œæ­¡è¿½çƒ", lat: 25.033964, lon: 121.564468 },
            { id: 998, name: "æ¸¬è©¦è²“", species: "æ©˜è²“", image_url: "{{ url_for('static', filename='mock_cat.png', _external=True) }}", tags: ["é«˜å†·", "æ…¢ç†Ÿæ€•ç”Ÿ"], location: "æ¨¡æ“¬å’–å•¡å»³", interactionNote: "ä¸å–œæ­¡æ‘¸è‚šå­", lat: 25.040183, lon: 121.547192 }
        ];

        let currentPetIndex = 0; 
        const MAX_EXPLORE_RANGE = 10; 

        // ----------------------------------------------------
        // 1. æ ¸å¿ƒé‚è¼¯ - å¡ç‰‡å †ç–Š
        // ----------------------------------------------------
        
        // å‡½æ•¸ï¼šæ ¹æ“šç´¢å¼•ç”Ÿæˆå¡ç‰‡æ•¸æ“š 
        function generateCardDataByIndex(index) {
            if (index < 0 || index >= availablePets.length) return null;

            const petData = availablePets[index];
            
            let currentDistanceKm = ((Math.random() * 0.5) + 0.5).toFixed(1); 
            let matchPercentage = ((Math.random() * 40) + 60).toFixed(0) + "%";
            
            let safetyText = "å¯äº’å‹•";
            let safetyClass = "bg-success";

            const translationMap = {
                'dog': 'ç‹—ç‹—',
                'cat': 'è²“å’ª',
                'other': 'å…¶ä»–å¯µç‰©',
                'active': 'æ´»æ½‘å¥½å‹•',
                'shy': 'æ…¢ç†Ÿæ€•ç”Ÿ',
                'dogFriendly': 'å°ç‹—å‹å–„',
                'catFriendly': 'å°è²“å‹å–„',
            };
            
            const translatedTags = petData.tags 
                ? (Array.isArray(petData.tags) ? petData.tags.map(tag => translationMap[tag] || tag).join(' / ') : petData.tags) 
                : 'ç„¡æ¨™ç±¤';

            // ç¢ºä¿ safetyText çš„åˆ¤æ–·ä¾ç„¶åŸºæ–¼åŸå§‹ä»£ç¢¼ 'shy'
            if (petData.tags && (Array.isArray(petData.tags) ? petData.tags.includes('shy') : tagsString.includes('æ…¢ç†Ÿæ€•ç”Ÿ'))) {
                safetyText = "æ…¢ç†Ÿ/éœ€è§€å¯Ÿ";
                safetyClass = "bg-warning text-dark";
            }
            
            // ç¢ºä¿åœ–ç‰‡ URL å­˜åœ¨
            const imageUrl = petData.image_url || 'https://via.placeholder.com/400x150?text=Pet+Image+Missing';

            return {
                id: petData.id,
                name: petData.name,
                breed: translationMap[petData.species] || petData.species, 
                distance: currentDistanceKm,
                personality: translatedTags, 
                match: matchPercentage,
                safetyText: safetyText,
                safetyClass: safetyClass,
                image_url: imageUrl
            };
        }


        // å‡½æ•¸ï¼šæ¸²æŸ“å †ç–Šä¸­çš„æ‰€æœ‰å¡ç‰‡ 
        function renderAllCardsInStack() {
            const container = document.getElementById('swipe-card-container');
            container.innerHTML = ''; 

            if (currentPetIndex >= availablePets.length) { 
                // æ‡‰ç”¨ç¾åŒ–å¾Œçš„çµæŸèªå¥
                container.innerHTML = `
                    <div class="text-center mt-5 text-secondary p-4" style="border: 1px dashed #ccc; border-radius: 10px;">
                        <h3 class="text-primary"><i class="bi bi-check-circle-fill"></i></h3>
                        <h3>æ­å–œï¼æ¢ç´¢å®Œç•¢ï¼</h3>
                        <p>æ‚¨å·²æŸ¥çœ‹æ‰€æœ‰é™„è¿‘çš„æ¯›å­©æª”æ¡ˆã€‚<br>è«‹ç¨å€™æˆ–èª¿æ•´æ¢ç´¢ç¯„åœã€‚</p>
                    </div>`;
                document.querySelector('.swipe-buttons').style.display = 'none';
                return;
            }

            document.querySelector('.swipe-buttons').style.display = 'flex';
            
            // å¾ currentPetIndex é–‹å§‹æ¸²æŸ“ 3 å¼µå¡ç‰‡
            for (let i = 0; i < 3; i++) {
                
                const indexToRender = currentPetIndex + i; 
                if (indexToRender >= availablePets.length) break;

                const petData = generateCardDataByIndex(indexToRender);
                if (petData === null) continue;

                // å †ç–Šæ•ˆæœ
                const zIndex = 3 - i;
                const scale = 1 - i * 0.03; 
                const translateY = i * 10; 
                const opacity = 1;
                
                // æ¸²æŸ“å¡ç‰‡ HTMLï¼Œå¥—ç”¨æ–°çš„ç¾åŒ–çµæ§‹å’Œæ¨£å¼
                const cardHtml = `
                    <div class="swipe-card" id="card-${petData.id}" data-index="${petData.id}" 
                        style="z-index: ${zIndex}; transform: translate(0, ${translateY}px) scale(${scale}); opacity: ${opacity};">
                        
                        <div class="pet-photo-placeholder">
                            <img src="${petData.image_url}" alt="${petData.name}">
                        </div>
                        
                        <div class="pet-profile-detail">
                            <h4 class="text-dark">${petData.name} (${petData.breed}) <span class="badge rounded-pill ${petData.safetyClass} ms-2">${petData.safetyText}</span></h4>
                            <p class="mb-1 text-muted"><i class="bi bi-geo-alt me-1 text-secondary"></i> è·é›¢ï¼š <strong>${petData.distance} km</strong></p>
                            <p class="mb-3 text-muted"><i class="bi bi-tag-fill me-1 text-secondary"></i> å€‹æ€§ï¼š ${petData.personality}</p>
                            
                            <button class="btn btn-outline-primary w-100 mt-3" 
                                onclick="event.stopPropagation(); viewPassport(${petData.id})">
                                <i class="bi bi-journal-check me-1"></i> é…å°æŒ‡æ•¸ï¼š<strong>${petData.match}</strong> (é»æ“ŠæŸ¥çœ‹è­·ç…§)
                            </button>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', cardHtml); 
            }
        }


        // å‡½æ•¸ï¼šåŸ·è¡Œæ»‘å‹•å‹•ä½œ 
        function swipeAction(action) {
            const currentCard = document.querySelector('.swipe-card:nth-child(1)'); 
            if (!currentCard) {
                renderAllCardsInStack();
                return;
            }
            
            // 1. åŸ·è¡Œå‹•ç•«
            if (action === 'like') {
                currentCard.style.transform = 'translate(400px, 0) rotate(15deg) scale(0.5)';
                currentCard.style.opacity = 0;
                console.log(`æˆåŠŸå° ${currentCard.querySelector('h4').textContent.split('(')[0].trim()} å‚³é€äº†ã€å–œæ­¡ã€!`);
            } else if (action === 'skip') {
                currentCard.style.transform = 'translate(-400px, 0) rotate(-15deg) scale(0.5)';
                currentCard.style.opacity = 0;
                console.log(`å·²è·³é ${currentCard.querySelector('h4').textContent.split('(')[0].trim()}ã€‚`);
            }

            // 2. ç§»é™¤ç•¶å‰å¡ç‰‡ä¸¦æ›´æ–°ç´¢å¼•
            setTimeout(() => {
                currentCard.remove();
                
                currentPetIndex++; 
                
                renderAllCardsInStack(); 
                
            }, 500); 
        }
        
        // â­ æ–°å¢ï¼šç”¨æ–¼æŒ‰éˆ•è·³è½‰çš„ JavaScript å‡½æ•¸
        function viewPassport(petId) {
            window.location.href = `/passport/${petId}`;
        }
        
        // ----------------------------------------------------
        // 2. è¼”åŠ©å‡½æ•¸èˆ‡åœ°åœ–åˆå§‹åŒ–
        // ----------------------------------------------------
        
        // AI Chat é‚è¼¯ 
        function sendAIQuery() {
            const inputElement = document.getElementById('gemini-input');
            const query = inputElement.value.trim();
            const chatHistory = document.getElementById('ai-chat-history');
            
            if (!query) return;

            chatHistory.innerHTML += `<div class="chat-message user-message"><strong>æ‚¨:</strong> ${query}</div>`;
            inputElement.value = '';
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            fetch('/ai_chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: query })
            })
            .then(response => response.json())
            .then(data => {
                chatHistory.innerHTML += `<div class="chat-message ai-message"><strong>ğŸ¤– AI:</strong> ${data.response}</div>`;
                chatHistory.scrollTop = chatHistory.scrollHeight;
            })
            .catch(error => {
                chatHistory.innerHTML += `<div class="chat-message ai-message"><strong>ğŸ¤– AI:</strong> æœå‹™é€£ç·šå¤±æ•—æˆ–å¾Œç«¯éŒ¯èª¤ã€‚</div>`;
                chatHistory.scrollTop = chatHistory.scrollHeight;
                console.error('AI fetch error:', error);
            });
        }

        document.getElementById('gemini-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                sendAIQuery();
            }
        });

        // Weather é‚è¼¯ 
        async function getWeather() {
            let cityInput = document.getElementById("cityInput").value.trim();
            const cityMap = { 
                "å°åŒ—": "Taipei", "å°åŒ—å¸‚": "Taipei", "æ–°åŒ—": "New Taipei", "æ–°åŒ—å¸‚": "New Taipei",
                "å°ä¸­": "Taichung", "å°ä¸­å¸‚": "Taichung", "å°å—": "Tainan", "å°å—å¸‚": "Tainan",
                "é«˜é›„": "Kaohsiung", "é«˜é›„å¸‚": "Kaohsiung", "åŸºéš†": "Keelung", "åŸºéš†å¸‚": "Keelung",
                "æ¡ƒåœ’": "Taoyuan", "æ¡ƒåœ’å¸‚": "Taoyuan", "æ–°ç«¹": "Hsinchu", "æ–°ç«¹å¸‚": "Hsinchu",
                "è‹—æ —": "Miaoli", "å½°åŒ–": "Changhua", "å—æŠ•": "Nantou", "é›²æ—": "Yunlin",
                "å˜‰ç¾©": "Chiayi", "å˜‰ç¾©å¸‚": "Chiayi", "å±æ±": "Pingtung", "å®œè˜­": "Yilan",
                "èŠ±è“®": "Hualien", "å°æ±": "Taitung", "æ¾æ¹–": "Penghu", "é‡‘é–€": "Kinmen",
                "é€£æ±Ÿ": "Lienchiang"
            }; 
            let city = cityMap[cityInput] || cityInput;

            const apiKey = "83b7835fd502cff5c1fe69ce70a7fe7e"; // æ‚¨çš„ OpenWeatherMap Key

            if (!city) {
                document.getElementById("weatherResult").innerHTML = "è«‹è¼¸å…¥åŸå¸‚åç¨±";
                return;
            }

            const url = `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&units=metric&lang=zh_tw`;

            try {
                const res = await fetch(url);
                const data = await res.json();

                if (data.cod !== 200) {
                    document.getElementById("weatherResult").innerHTML = "æŸ¥ä¸åˆ°é€™å€‹åŸå¸‚";
                    return;
                }

                document.getElementById("weatherResult").innerHTML = `
                    <p><strong>åŸå¸‚ï¼š</strong> ${data.name}</p>
                    <p><strong>å¤©æ°£ï¼š</strong> ${data.weather[0].description}</p>
                    <p><strong>æº«åº¦ï¼š</strong> ${data.main.temp}Â°C</p>
                    <p><strong>æ¿•åº¦ï¼š</strong> ${data.main.humidity}%</p>
                `;
            } catch (err) {
                document.getElementById("weatherResult").innerHTML = "æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
            }
        }
        
        let map;

        document.addEventListener("DOMContentLoaded", function () {
            
            // å»ºç«‹åœ°åœ– 
            map = L.map('map-view').setView([25.033964, 121.564468], 15);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            // â­ é—œéµä¿®æ­£ï¼šå¼·åˆ¶åœ°åœ–é‡ç¹ª (è§£æ±ºåœ°åœ–æ¶ˆå¤±å•é¡Œ)
            setTimeout(function() {
                map.invalidateSize();
            }, 100); 

            // â­ åŠ ä¸Šã€Œç›®å‰ä½¿ç”¨è€…ä½ç½®ã€æŒ‰éˆ•åŠŸèƒ½
            document.getElementById("locate-map-btn").addEventListener("click", () => {
                map.locate({ setView: true, maxZoom: 17 });
            });

            // â­ é¡¯ç¤ºå®šä½ï¼ˆæˆåŠŸï¼‰
            map.on("locationfound", function (e) {
                L.marker(e.latlng).addTo(map)
                    .bindPopup("ğŸ“ æ‚¨ç¾åœ¨åœ¨é€™è£¡ï¼")
                    .openPopup();
            });

            // â­ é¡¯ç¤ºéŒ¯èª¤ï¼ˆå¤±æ•—ï¼‰
            map.on("locationerror", function () {
                alert("âš  ç„¡æ³•å–å¾—å®šä½ï¼Œè«‹ç¢ºèªç€è¦½å™¨æ¬Šé™");
            });

            // â­ é—œéµä¿®æ”¹ï¼šä½¿ç”¨ geo-coded åº§æ¨™ä¾†æ¨™è¨˜åœ°é»
            availablePets.forEach(spot => {
                // æª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„ç¶“ç·¯åº¦æ•¸æ“š
                if (spot.lat && spot.lon) {
                    L.marker([spot.lat, spot.lon]).addTo(map)
                        .bindPopup(`ğŸ¾ ${spot.name} (${spot.species})ï¼š${spot.location}`);
                    
                    // è¨­ç½®åœ°åœ–ä¸­å¿ƒç‚ºç¬¬ä¸€å€‹å¯µç‰©çš„ä½ç½® (å¯é¸)
                    if (availablePets.length > 0 && spot.id === availablePets[0].id) {
                        map.setView([spot.lat, spot.lon], 15);
                    }
                } else {
                    // å¦‚æœåœ°ç†ç·¨ç¢¼å¤±æ•—ï¼Œé¡¯ç¤ºåœ¨é è¨­ä¸­å¿ƒé» (åƒ…ç”¨æ–¼èª¿è©¦)
                    // console.warn(`å¯µç‰© ${spot.name} åœ°ç†ç·¨ç¢¼å¤±æ•—ï¼Œç„¡æ³•æ¨™è¨˜ç²¾ç¢ºä½ç½®ã€‚`);
                }
            });
            
            // ----------------------------------------------------
            // åˆå§‹åŒ–å¡ç‰‡
            // ----------------------------------------------------
            renderAllCardsInStack(); 
        });
        
    </script>
</body>
</html>