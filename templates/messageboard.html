<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <title>ğŸš¨ æ¯›å­©å›å®¶æƒ…å ±ç«™ - èµ°å¤±å¯µç‰©å”å°‹ä¸­å¿ƒ ğŸ¾</title>
    <meta content="å³æ™‚ç™¼å¸ƒèµ°å¤±å•Ÿäº‹ï¼Œä¸¦æä¾›å”å°‹ç·šç´¢çš„è³‡è¨Šä¸­å¿ƒ" name="description">

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&family=Noto+Sans+TC:wght@400;700&family=Chakra+Petch:wght@700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        /* ğŸ¨ å…¨åŸŸ/è®Šæ•¸å®šç¾© - ç·Šæ€¥ç´…/æ©™è‰²ä¸»é¡Œ */
        :root {
            /* å“ç‰Œæ ¸å¿ƒè‰² (ç´…è‰²ä¸»é¡Œ) */
            --bs-primary: #D32F2F; /* æ ¸å¿ƒè‰²ï¼šç·Šæ€¥ç´…è‰² */
            --bs-primary-rgb: 211, 47, 47;
            --bs-secondary: #FF9800; /* æ¬¡è¦è‰²ï¼šè­¦ç¤ºæ©™è‰² */
            --bs-light-bg: #F9F9F9; /* æ¥µæ·ºèƒŒæ™¯ */
            
            /* æ——å¹Ÿé…è‰² */
            --banner-main: var(--bs-primary); 
            --banner-sub-text-color: #A31F1F; /* æ·±ç´… */
            --text-light: #FFFFFF;

            /* è¼”åŠ©é¡è‰² */
            --border-accent: #E57373; /* æ——å¹Ÿä¸‹æ–¹çš„ç´°ç·šé¡è‰² */
            --button-border: #FF9800; /* è¿”å›æŒ‰éˆ•é‚Šæ¡†é¡è‰² */
            --dark-footer: #424242; /* æ·±ç°é å°¾ */
            --highlight-green: #00796b; /* ç•™è¨€å€çš„ç¶ è‰²ä¿æŒä¸è®Šï¼Œä»£è¡¨ã€Œå®‰å…¨/æ‰¾åˆ°ã€çš„å¸Œæœ› */
        }
        
        /* Keyframes for animations (ä¿æŒä¸è®Š) */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulseNewMessage {
            0% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 152, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0); }
        }
        @keyframes highlightNew {
            0% { background-color: #fff3e0; }
            100% { background-color: #ffffff; }
        }
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* ğŸ–‹ï¸ å­—é«”è¨­å®š */
        body {
            background-color: var(--bs-light-bg);
            font-family: 'Noto Sans TC', 'Poppins', sans-serif;
            color: #333;
        }
        h1, h3, h5, .creative-title-container *, .sub-text-under-banner {
            font-family: 'Fredoka', 'Chakra Petch', sans-serif; 
            font-weight: 700;
        }

        /* ğŸï¸ é é¢æ¨™é ­å€å¡Š (Header) */
        .page-header { 
            background: linear-gradient(135deg, #FFEBEE 0%, #FFCCBC 100%); 
            padding: 50px 0; 
            margin-bottom: 30px; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            animation: fadeIn 1s ease-out;
            border-bottom: none;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 250px; 
            position: relative; 
            flex-direction: column; 
        }
        .page-header .container {
             display: flex;
             flex-direction: column; 
             align-items: center; 
             justify-content: center; 
             width: 100%; 
        }
        .page-header h1, .page-header p { 
            display: none !important;
        }

        /* ================================================= */
        /* ğŸ† å‰µæ„æ¨™é¡Œæ¨£å¼ (æ——å¹Ÿ - ç´…è‰²) */
        /* ================================================= */

        .creative-title-container {
            display: inline-block;
            text-align: center;
            position: relative;
            padding-bottom: 0; 
            margin-bottom: 5px; 
            z-index: 10; 
        }
        .main-title-banner {
            background-color: var(--banner-main); 
            color: var(--text-light);
            padding: 20px 50px; 
            font-size: 3rem; 
            line-height: 1.2;
            position: relative;
            z-index: 2; 
            clip-path: polygon(0 0, 5% 50%, 0 100%, 100% 100%, 95% 50%, 100% 0);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.25); 
        }
        .main-title-banner i {
            font-size: 2.5rem; 
            vertical-align: middle; 
            margin-right: 15px;
        }
        .main-title-banner::after {
            content: '';
            position: absolute;
            bottom: -5px; 
            left: 5%; 
            right: 5%; 
            height: 5px;
            background-color: var(--border-accent); 
            z-index: 3;
            clip-path: polygon(0 0, 100% 0, 97% 100%, 3% 100%); 
        }
        .sub-text-under-banner {
            color: var(--banner-sub-text-color); 
            font-size: 1.5rem;
            margin-top: 10px; 
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5); 
        }
        
        /* --- æŒ‰éˆ•ç¾¤çµ„ (åœ¨æ¨™é¡Œä¸‹æ–¹) --- */
        .button-group-under-title {
            margin-top: 25px; 
        }
        .btn-outline-primary {
            color: var(--bs-secondary); 
            border-color: var(--bs-secondary);
            background-color: white; 
            padding: 0.5rem 1rem; 
            font-weight: 600;
            border-radius: 10px; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); 
            transition: all 0.3s ease;
        }
        .btn-outline-primary:hover {
            background-color: var(--bs-secondary);
            color: white;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            transform: scale(1.03); 
        }
        
        /* ================================================= */
        /* å…§å®¹å€å¡Šæ¨£å¼ (èˆ‡æ–°ä¸»é¡Œè‰²åŒæ­¥) */
        /* ================================================= */

        /* å…§å®¹å¡ç‰‡é€šç”¨æ¨£å¼ */
        .content-card { 
            padding: 40px;
            border-left: 5px solid var(--bs-secondary); 
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            min-height: 400px;
            border-radius: 12px;
            background-color: #ffffff;
            animation: fadeIn 1.2s ease-out 0.2s forwards;
            /* å¼·åˆ¶è®“åœ–ç‰‡å¡ç‰‡å¯ä»¥é»æ“Š */
            cursor: pointer; 
        }

        /* èµ°å¤±å¯µç‰©åˆ—è¡¨æ¨£å¼ */
        .pet-card {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .pet-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        .pet-card .card-img-top {
            height: 200px;
            object-fit: cover;
        }
        .pet-card .badge-urgent {
            background-color: var(--bs-primary) !important; 
            animation: pulseNewMessage 1.5s infinite;
        }
        .pet-card .card-title {
             color: var(--bs-primary); 
        }

        /* å°èˆªåˆ—æ¨£å¼ */
        .app-nav {
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0; /* èª¿æ•´é‚Šæ¡†é¡è‰² */
        }
        .nav-link {
            color: #6c757d; /* éæ´»èºæ¨™ç±¤æ–‡å­—é¡è‰² */
            font-weight: 600;
            padding: 0.8rem 1.5rem;
            transition: all 0.3s ease;
        }
        .nav-link:hover {
            color: var(--bs-primary) !important; /* hover æ™‚æ–‡å­—è®Šç´…è‰² */
            border-bottom: 3px solid var(--bs-primary); /* hover æ™‚é¡¯ç¤ºåº•éƒ¨ç´…è‰²é‚Šæ¡† */
        }
        .nav-link.active {
            background-color: var(--bs-primary) !important; /* æ´»èºæ¨™ç±¤èƒŒæ™¯è‰²ç‚ºç´…è‰² */
            color: var(--text-light) !important; /* æ´»èºæ¨™ç±¤æ–‡å­—é¡è‰²ç‚ºç™½è‰² */
            border-bottom: 3px solid var(--bs-primary); /* æ´»èºæ¨™ç±¤åº•éƒ¨é‚Šæ¡†ç‚ºç´…è‰² */
            border-radius: 8px 8px 0 0; /* åœ“è§’æ•ˆæœ */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* å¢åŠ é™°å½± */
        }
        
        /* è¡¨å–®æ¨£å¼ */
        #newPostForm .form-label {
            font-weight: 700;
            color: var(--highlight-green); 
        }
        #newPostForm input[type="file"] {
            border: 1px dashed #ccc;
            padding: 10px;
            border-radius: 5px;
        }
        .btn-success {
            background-color: var(--bs-secondary); 
            border-color: var(--bs-secondary);
            transition: all 0.3s ease;
        }
        .btn-success:hover {
            background-color: #f57c00;
            border-color: #f57c00;
            transform: scale(1.03);
        }

        /* ç•™è¨€å€ç´°ç¯€æ¨£å¼ */
        .message-entry {
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .message-entry.owner-reply {
            border-left: 5px solid #1976d2 !important; 
            background-color: #e3f2fd !important;
        }
        .message-header {
            font-weight: 700;
            color: var(--highlight-green); 
            margin-bottom: 5px;
            border-bottom: 1px dashed #cfd8dc;
            padding-bottom: 5px;
        }
        .message-entry .badge.bg-success {
             background-color: var(--highlight-green) !important;
        }
        
        /* é å°¾ */
        .bg-dark {
             background-color: var(--dark-footer) !important; 
        }
    </style>
</head>
<body>

    <div class="container-fluid page-header">
        <div class="container text-center">
            
            <div class="creative-title-container">
                <div class="main-title-banner">
                    <i class="bi bi-bullhorn-fill me-2"></i>æµªæµªå›å®¶æƒ…å ±ç«™
                </div>
            </div>
            
            <div class="sub-text-under-banner">å³æ™‚ç·šç´¢å½™æ•´ï¼æ¯ä¸€ä»½æ„›å¿ƒï¼Œéƒ½æ˜¯ç‰ å›å®¶çš„è·¯</div>
            
<div class="button-group-under-title">
    <a href="{{ url_for('show_main_map') }}" class="btn btn-outline-primary btn-sm mt-3">
        <i class="bi bi-arrow-left me-2"></i>è¿”å›åœ°åœ–é¦–é 
    </a>
</div>
        </div>
    </div>

    <div class="container">
        <ul class="nav nav-pills app-nav justify-content-center">
            <li class="nav-item">
                <a class="nav-link active" id="list-tab" data-target="list-view" href="#"><i class="bi bi-list-columns-reverse me-2"></i>èµ°å¤±å¯µç‰©åˆ—è¡¨</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="post-tab" data-target="post-view" href="#"><i class="bi bi-megaphone-fill me-2"></i>ç™¼å¸ƒèµ°å¤±å•Ÿäº‹</a>
            </li>
        </ul>
    </div>
    
    <div class="container py-3">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                
                <div id="list-view" class="view-section">
                    <h2 class="text-dark mb-4"><i class="bi bi-search me-2"></i>æœ€æ–°å¤±è¹¤å ±å‘Š</h2>
                    <div class="row" id="petListContainer">
                        </div>
                </div>

                <div id="post-view" class="view-section" style="display: none;">
                    <div class="bg-white rounded content-card">
                        <h2 class="text-danger mb-4"><i class="bi bi-clipboard-pulse me-2"></i>å¡«å¯«èµ°å¤±å•Ÿäº‹</h2>
                        <form id="newPostForm" method="POST" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="petName" class="form-label">å¯µç‰©åç¨±/æš±ç¨±</label>
                                <input type="text" class="form-control" id="petName" name="petName" required placeholder="ä¾‹å¦‚ï¼šçš®çš®">
                            </div>
                            <div class="mb-3">
                                <label for="petSpecies" class="form-label">å“ç¨®/é¡åˆ¥</label>
                                <input type="text" class="form-control" id="petSpecies" name="petSpecies" required placeholder="ä¾‹å¦‚ï¼šæŸ´çŠ¬ã€ä¸‰èŠ±è²“ã€ç±³å…‹æ–¯">
                            </div>
                            <div class="mb-3">
                                <label for="lostDate" class="form-label">èµ°å¤±æ™‚é–“/æ—¥æœŸ</label>
                                <input type="datetime-local" class="form-control" id="lostDate" name="lostDate" required>
                            </div>
                            <div class="mb-3">
                                <label for="lostLocation" class="form-label">æœ€å¾Œç›®æ“Šåœ°é» (è¶Šè©³ç´°è¶Šå¥½)</label>
                                <input type="text" class="form-control" id="lostLocation" name="lostLocation" required placeholder="ä¾‹å¦‚ï¼šå¤§å®‰æ£®æ—å…¬åœ’æ±å´å‡ºå£">
                            </div>
                            <div class="mb-3">
                                <label for="petFeatures" class="form-label">é—œéµç‰¹å¾µèˆ‡å€‹æ€§</label>
                                <textarea class="form-control" id="petFeatures" name="petFeatures" rows="3" required placeholder="ä¾‹å¦‚ï¼šç¶ è‰²é …åœˆã€å€‹æ€§è†½å°ã€è¦ªäººä½†æ€•ç‹—..."></textarea>
                            </div>
                            <div class="mb-4">
                                <label for="petImage" class="form-label">å¯µç‰©ç…§ç‰‡ (å»ºè­°ä¸€å¼µæ¸…æ™°è¿‘ç…§)</label>
                                <input type="file" class="form-control" id="petImage" name="petImage" accept="image/*">
                            </div>
                            <button type="submit" class="btn btn-success w-100 py-2"><i class="bi bi-check-circle-fill me-2"></i>ç«‹å³ç™¼å¸ƒå”å°‹</button>
                        </form>
                    </div>
                </div>

                <div id="detail-view" class="view-section" style="display: none;">
                    <button class="btn btn-outline-secondary mb-3" id="backToList"><i class="bi bi-arrow-left me-2"></i>è¿”å›å¯µç‰©åˆ—è¡¨</button>
                    <div class="bg-white rounded content-card">
                        <div id="petDetailContent">
                            </div>
                        
                        <h6>æä¾›ç·šç´¢ / ç•™è¨€å€</h6>
                        
                        <div class="mb-4">
                            <textarea id="messageInput" class="form-control mb-2" rows="3" placeholder="è«‹ç•™ä¸‹æ‚¨çš„ç™¼ç¾æˆ–å•é¡Œ..."></textarea>
                            <button id="postMessageBtn" class="btn btn-success"><i class="bi bi-reply-fill me-2"></i>ç™¼å¸ƒç·šç´¢</button>
                        </div>

                        <div id="messageList"> 
                            </div>

                    </div>
                </div>
                
            </div>
        </div>
    </div>

    <div class="container-fluid bg-dark text-white-50 py-3 mt-auto mt-5">
        <div class="container text-center">
            <p class="mb-0 small">&copy; æ¯›å­©å›å®¶æƒ…å ±ç«™. All Rights Reserved.</p>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // -------------------------------------------------------------
        // 1. å…¨åŸŸè®Šæ•¸èˆ‡åˆå§‹åŒ–
        // -------------------------------------------------------------
        // â­ å¾ Flask æ¨¡æ¿æ¥æ”¶æ•¸æ“š (ä½¿ç”¨ tojson éæ¿¾å™¨ï¼Œç¢ºä¿æ•¸æ“šæ˜¯ JSON æ ¼å¼)
        const allPosts = {{ posts | tojson }};
        const allMessages = {{ messages | tojson }};
        
        const views = {
            'list-view': document.getElementById('list-view'),
            'post-view': document.getElementById('post-view'),
            'detail-view': document.getElementById('detail-view')
        };
        const navTabs = document.querySelectorAll('.nav-link');
        const backButton = document.getElementById('backToList');
        const petListContainer = document.getElementById('petListContainer');
        const newPostForm = document.getElementById('newPostForm');
        const detailContent = document.getElementById('petDetailContent');
        const messageListContainer = document.getElementById('messageList');

        let currentPostId = null; // ç•¶å‰æŸ¥çœ‹çš„å•Ÿäº‹ ID

        // -------------------------------------------------------------
        // 2. è¼”åŠ©å‡½æ•¸ï¼šæ¸²æŸ“èˆ‡æ ¼å¼åŒ–
        // -------------------------------------------------------------

        // æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“
        function formatPostTime(timestamp) {
            // ç”±æ–¼ Flask å¾Œç«¯å·²å°‡æ™‚é–“æ ¼å¼åŒ–ç‚ºå­—ä¸² (datetime.now().strftime)ï¼Œé€™è£¡ç›´æ¥é¡¯ç¤º
            // å¦‚æœéœ€è¦å‰ç«¯è™•ç†ï¼Œæœƒæ›´è¤‡é›œï¼Œé€™è£¡åªåšåŸºç¤æª¢æŸ¥
            if (timestamp) {
                 return timestamp;
            }
            return 'æœªçŸ¥æ™‚é–“';
        }

        // æ¸²æŸ“å–®å€‹ç•™è¨€
        function renderMessage(message) {
            const isOwner = message.isOwnerReply;
            const className = isOwner ? 'message-entry owner-reply' : 'message-entry';
            const headerClass = isOwner ? 'message-header text-primary' : 'message-header';
            const username = isOwner ? 'é£¼ä¸»æœ¬äºº' : message.username;
            
            return `
                <div class="${className}" style="animation: slideInRight 0.5s ease-out;">
                    <div class="${headerClass}">
                        ${username} <small class="text-muted">(${formatPostTime(message.postTime)})</small>
                        ${isOwner ? '<span class="badge bg-primary ms-2">ä¸»äººå›è¦†</span>' : ''}
                    </div>
                    <p class="mb-0">${message.content.replace(/\n/g, '<br>')}</p>
                </div>
            `;
        }
        
        // æ¸²æŸ“èµ°å¤±å•Ÿäº‹åˆ—è¡¨
        function renderPetList(posts) {
            petListContainer.innerHTML = ''; // æ¸…ç©ºç¾æœ‰åˆ—è¡¨
            
            if (posts.length === 0) {
                 petListContainer.innerHTML = '<p class="text-center text-muted mt-5">ç›®å‰æ²’æœ‰èµ°å¤±å ±å‘Šï¼Œæ˜¯å€‹å¹³å®‰çš„æ—¥å­ï¼</p>';
                 updatePetCount(0);
                 return;
            }
            
            posts.forEach(post => {
                const featuresSnippet = post.petFeatures.substring(0, 35) + (post.petFeatures.length > 35 ? '...' : '');
                // æ‰¾åˆ°æœ€æ–°çš„ç•™è¨€
                const latestMessage = allMessages
                    .filter(msg => msg.postId === post.id)
                    .sort((a, b) => new Date(b.postTime) - new Date(a.postTime))[0];

                const latestInfo = latestMessage 
                    ? `æœ€æ–°ç·šç´¢ï¼š${formatPostTime(latestMessage.postTime)}` 
                    : 'æœ€æ–°ç·šç´¢ï¼šç„¡';
                const badgeClass = post.isResolved ? 'bg-success' : 'badge-urgent';
                const badgeText = post.isResolved ? 'å·²å°‹ç²' : 'ç·Šæ€¥å”å°‹';
                
                // ç¢ºä¿åœ–ç‰‡è·¯å¾‘æ­£ç¢ºï¼Œå¦‚æœæ²’æœ‰ä¸Šå‚³åœ–ç‰‡ï¼Œä½¿ç”¨é è¨­åœ–ç‰‡
                const imageUrl = post.imageUrl || '{{ url_for('static', filename='img/default_pet.png') }}';

                const postHtml = `
                    <div class="col-md-6 mb-4">
                        <div class="card pet-card" data-post-id="${post.id}">
                            <img src="${imageUrl}" class="card-img-top" alt="${post.petName}">
                            <div class="card-body">
                                <span class="badge ${badgeClass}">${badgeText}</span>
                                <h5 class="card-title">${post.petName} (${post.petSpecies})</h5>
                                <p class="card-text small text-muted">èµ°å¤±æ™‚é–“ï¼š${post.lostDate ? formatPostTime(post.lostDate) : 'æœªçŸ¥'} | åœ°é»ï¼š${post.lostLocation} | ç‰¹å¾µï¼š${featuresSnippet}</p>
                                <p class="mb-0 small text-success">**${latestInfo}**</p>
                            </div>
                        </div>
                    </div>
                `;
                petListContainer.insertAdjacentHTML('beforeend', postHtml);
            });
            
            // é‡æ–°ç¹«çµå¡ç‰‡é»æ“Šäº‹ä»¶
            document.querySelectorAll('.pet-card').forEach(card => {
                card.removeEventListener('click', handleCardClick);
                card.addEventListener('click', handleCardClick);
            });

            updatePetCount(posts.length);
        }
        
        // -------------------------------------------------------------
        // 3. é é¢/æ•¸æ“šäº¤äº’é‚è¼¯
        // -------------------------------------------------------------
        
        function showView(targetId) {
            // éš±è—æ‰€æœ‰å€å¡Š
            Object.values(views).forEach(view => {
                if (view) view.style.display = 'none';
            });
            // é¡¯ç¤ºç›®æ¨™å€å¡Š
            if (views[targetId]) {
                views[targetId].style.display = 'block';
            }

            // æ›´æ–°å°èˆªåˆ—çš„ active ç‹€æ…‹
            navTabs.forEach(tab => tab.classList.remove('active'));
            if (targetId === 'list-view') {
                document.getElementById('list-tab').classList.add('active');
            } else if (targetId === 'post-view') {
                document.getElementById('post-tab').classList.add('active');
            }
        }
        
        // è™•ç†å¡ç‰‡é»æ“Š (é€²å…¥è©³æƒ…é )
        function handleCardClick() {
            // ç¢ºä¿ post-id æ˜¯æ•¸å­—ï¼Œå› ç‚ºå¾Œç«¯ç”¨çš„æ˜¯ int
            currentPostId = parseInt(this.getAttribute('data-post-id') || this.getAttribute('data-pet-id')); 
            const post = allPosts.find(p => p.id === currentPostId);
            
            if (!post) {
                alert("æ‰¾ä¸åˆ°è©²å•Ÿäº‹è³‡æ–™ï¼");
                return;
            }

            // æ¸²æŸ“è©³æƒ…å…§å®¹
            detailContent.innerHTML = `
                <div style="animation: fadeIn 1s ease-out;">
                    <img src="${post.imageUrl || '{{ url_for('static', filename='img/default_pet.png') }}'}" class="img-fluid rounded mb-3" alt="${post.petName}" style="max-height: 400px; object-fit: cover; width: 100%;">
                    <h5>ğŸš¨ å”å°‹å•Ÿäº‹ï¼š${post.petName} (${post.petSpecies})</h5>
                    <p><strong>èµ°å¤±æ™‚é–“ï¼š</strong> ${formatPostTime(post.lostDate)}</p>
                    <p><strong>æœ€å¾Œåœ°é»ï¼š</strong> ${post.lostLocation}</p>
                    <p><strong>é—œéµç‰¹å¾µï¼š</strong> ${post.petFeatures.replace(/\n/g, '<br>')}</p>
                </div>
                <hr>
            `;
            
            // æ¸²æŸ“ç•™è¨€åˆ—è¡¨ (éæ¿¾ä¸¦æ’åº)
            const filteredMessages = allMessages
                .filter(msg => msg.postId === currentPostId)
                .sort((a, b) => new Date(b.postTime) - new Date(a.postTime)); // é™åºæ’åˆ— (æœ€æ–°åœ¨å‰)
                
            messageListContainer.innerHTML = filteredMessages.map(renderMessage).join('');

            showView('detail-view');
        }

        // -------------------------------------------------------------
        // 4. AJAX æäº¤é‚è¼¯ (æ ¸å¿ƒä¿®æ”¹)
        // -------------------------------------------------------------
        
        // 4.1 è™•ç†èµ°å¤±å•Ÿäº‹ç™¼å¸ƒ (ä½¿ç”¨ FormData è™•ç†æª”æ¡ˆä¸Šå‚³)
        newPostForm.addEventListener('submit', function(e) {
            e.preventDefault(); 
            const formData = new FormData(this);
            
            fetch('{{ url_for("handle_pet_post") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // å°‡æ–°æ•¸æ“šåŠ å…¥å…¨åŸŸè®Šæ•¸ï¼Œä¸¦é‡æ–°æ¸²æŸ“åˆ—è¡¨
                    allPosts.unshift(data.post_data);
                    // é‡æ–°æ¸²æŸ“æ•´å€‹åˆ—è¡¨ä»¥é¡¯ç¤ºæœ€æ–°çš„è²¼æ–‡
                    renderPetList(allPosts);
                    
                    this.reset();
                    alert(`èµ°å¤±å•Ÿäº‹ã€${data.post_data.petName}ã€‘å·²æˆåŠŸç™¼å¸ƒï¼`);
                    showView('list-view');
                } else {
                    alert('ç™¼å¸ƒå¤±æ•—: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ç¶²è·¯é€£ç·šéŒ¯èª¤ï¼Œç™¼å¸ƒå¤±æ•—ã€‚è«‹æª¢æŸ¥åœ–ç‰‡æª”æ¡ˆå¤§å°æˆ–æ ¼å¼ã€‚');
            });
        });

        // 4.2 è™•ç†ç•™è¨€ç·šç´¢ç™¼å¸ƒ (ä½¿ç”¨ JSON è™•ç†æ–‡å­—ç•™è¨€)
        document.getElementById('postMessageBtn').addEventListener('click', function() {
            const inputElement = document.getElementById('messageInput');
            const messageContent = inputElement.value.trim();

            if (messageContent === "" || currentPostId === null) {
                alert("è«‹è¼¸å…¥ç·šç´¢å…§å®¹ä¸¦ç¢ºä¿å·²é¸å®šå”å°‹å•Ÿäº‹ï¼");
                return;
            }
            
            const messagePayload = {
                'postId': currentPostId,
                'content': messageContent,
                'username': 'ç†±å¿ƒç¶²å‹' // é è¨­ä½¿ç”¨è€…åç¨±
            };
            
            fetch('{{ url_for("handle_message_post") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(messagePayload),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // å°‡æ–°æ•¸æ“šåŠ å…¥å…¨åŸŸè®Šæ•¸
                    allMessages.unshift(data.message_data);
                    
                    // æ¸…ç©ºè¼¸å…¥æ¡†
                    inputElement.value = "";
                    
                    // é‡æ–°æ¸²æŸ“ç•™è¨€åˆ—è¡¨ (ç›´æ¥å‘¼å«è©³æƒ…é é¢çš„æ¸²æŸ“é‚è¼¯)
                    // å¿…é ˆæ‰¾åˆ°ç•¶å‰å¡ç‰‡çš„ DOM å…ƒç´ ï¼Œé€™è£¡ç¨å¾®ç¹å€‹è·¯ç¢ºä¿ data-post-id æ­£ç¢º
                    const currentCard = document.querySelector(`.pet-card[data-post-id="${currentPostId}"]`);
                    if (currentCard) {
                        handleCardClick.call(currentCard);
                    }
                    
                    alert('ç·šç´¢å·²ç™¼å¸ƒï¼Œæ„Ÿè¬æ‚¨çš„å¹«åŠ©ï¼');
                } else {
                    alert('ç•™è¨€ç™¼å¸ƒå¤±æ•—: ' + data.message);
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('ç¶²è·¯é€£ç·šéŒ¯èª¤ï¼Œç•™è¨€å¤±æ•—ã€‚');
            });
        });

        // -------------------------------------------------------------
        // 5. äº‹ä»¶ç¶å®šèˆ‡å•Ÿå‹•
        // -------------------------------------------------------------
        
        // å°èˆªåˆ—é»æ“Šäº‹ä»¶ (ä¿ç•™åŸæœ‰é‚è¼¯ï¼Œä½†ç§»é™¤éœæ…‹å¡ç‰‡äº‹ä»¶)
        navTabs.forEach(tab => {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                const targetId = this.getAttribute('data-target');
                showView(targetId);
            });
        });

        // è¿”å›åˆ—è¡¨æŒ‰éˆ•äº‹ä»¶
        backButton.addEventListener('click', function() {
            showView('list-view');
        });

        // é é¢å•Ÿå‹•æ™‚ï¼šæ¸²æŸ“åˆå§‹åˆ—è¡¨
        document.addEventListener('DOMContentLoaded', () => {
            // ç”±æ–¼éœæ…‹å¡ç‰‡å·²ç§»é™¤ï¼Œé€™è£¡èª¿ç”¨ renderPetList
            renderPetList(allPosts);
        });

        // æ›´æ–°åˆ—è¡¨æ•¸é‡
        function updatePetCount(count) {
            const listTab = document.getElementById('list-tab');
            if (listTab) {
                const iconHtml = '<i class="bi bi-list-columns-reverse me-2"></i>';
                listTab.innerHTML = `${iconHtml}èµ°å¤±å¯µç‰©åˆ—è¡¨ (${count})`;
            }
        }
    </script>
</body>
</html>